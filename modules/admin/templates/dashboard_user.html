{% extends "struc.html" %}

{% block title %}Manage Users{% endblock %}
{% block page_title %}Manage Users{% endblock %}
{% block breadcrumb %}Manage Users{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('admin.static', filename='dashboard_user.css') }}"/>
{% endblock %}

{% block content %}
<script src="{{ url_for('admin.static', filename='dashboard_user.js') }}" defer></script>

<div class="dashboard-content fade-in">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- User Management Header -->
  <div class="user-management-header">
    <div class="header-left">
      <div class="user-stats">
        <div class="stat-card">
          <div class="stat-value" id="visible-users">{{ users | length }}</div> <!-- Total Users -->
          <div class="stat-label">Total Users</div>
        </div>
      </div>
    </div>

  </div>

  <!-- User Table -->
  <div class="table-card">
    <div class="table-header">
      <h3>Registered Users</h3>
      <div class="table-controls">
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Search users..." id="user-search" />
          <button class="search-btn"><i class="fas fa-search"></i></button>
        </div>
        <div class="filter-dropdown">
          <select class="form-select" id="user-filter">
            <option value="all">All Users</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <div class="table-scroll-container">
        <table class="user-table" id="users-table">
          <thead>
            <tr>
              <th class="select-col"><input type="checkbox" id="selectAll"></th>
              <th>User ID</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>NIC</th>
              <th>City</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if users %}
              {% for user in users %}
                <tr data-status="{{ user.status }}">
                  <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}"></td>
                  <td>UC-{{ '%04d' % user.id }}</td>
                  <td>
                    <div class="user-cell">
                      {% if user.user_image %}
                        <img class="user-avatar-img" src="data:image/jpeg;base64,{{ user.user_image | b64encode }}" alt="{{ user.full_name }}" />
                      {% else %}
                        <div class="user-avatar" style="background-color: #3b82f6;">
                          {{ user.full_name[:1] }}{{ user.full_name.split()[-1][:1] if user.full_name.split()|length > 1 else '' }}
                        </div>
                      {% endif %}
                      <div class="user-details">
                        <div class="user-name">{{ user.full_name }}</div>
                        
                      </div>
                    </div>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.nic }}</td>
                  <td>{{ user.city }}</td>
                  <td>
                    <div class="action-buttons">
                      <a href="{{ url_for('user_mgmt.view_user', id=user.id) }}" class="action-btn view-btn" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
    
                      <form method="POST" action="{{ url_for('user_mgmt.delete_user', id=user.id) }}" 
                        onsubmit="return confirm('Are you sure you want to delete this user?');" 
                        style="display:inline;">
                        <button type="submit" class="action-btn delete-btn" title="Delete">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center">No users found.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}
